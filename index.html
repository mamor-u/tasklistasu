<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>タスク管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }

        #controls {
            margin-bottom: 10px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        button {
            padding: 10px 16px;
            font-size: 16px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
            cursor: default;
        }

        #matrix-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            aspect-ratio: 1/1;
            border: 2px solid #333;
            background: #f9f9f9;
        }

        canvas {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .task {
            position: absolute;
            width: 30%;
            min-width: 90px;
            max-width: 130px;
            padding: 6px 10px;
            color: white;
            border-radius: 6px;
            cursor: grab;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            z-index: 10;
            font-size: 13px;
            text-align: center;
        }
        .task.selected {
            outline: 3px solid red;
        }

        #taskList {
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-width: 600px;
        }

        .task-list-item {
            padding: 6px 10px;
            border-radius: 6px;
            color: white;
            font-weight: bold;
            font-size: 13px;
            cursor: grab;
            user-select: none;
        }
        .task-list-item.selected {
            outline: 2px solid red;
        }

        #totalTime {
            font-weight: bold;
            margin-top: 10px;
        }

        /* ▼ 追加：完了タスク一覧エリア用 */
        #completedTaskList {
            display: none;
            margin-top: 20px;
            border-top: 1px solid #ccc;
            padding-top: 10px;
            max-width: 600px;
        }
        .completed-item {
            background-color: #666;
            color: #fff;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 13px;
        }
    </style>
</head>
<body>
    <div id="controls">
        <button id="addTaskBtn">タスク追加</button>
        <button id="editTaskBtn" disabled>編集</button>
        <button id="deselectTaskBtn" disabled>選択解除</button>
        <button id="deleteTaskBtn" disabled>削除</button>

        <!-- ▼ 新規追加ボタン -->
        <button id="completeTaskBtn" disabled>タスク完了</button>
        <button id="toggleCompletedBtn">完了タスク一覧</button>

        <button id="recommendBtn">おすすめ優先順位</button>
    </div>

    <div id="matrix-container"><canvas id="axisCanvas" width="600" height="600"></canvas></div>
    <div id="totalTime">全タスクの合計時間: 0時間0分</div>
    <div id="selectedTime">選択タスクの合計時間: 0時間0分</div>

    <div id="taskList"></div>
    <div id="completedTaskList"></div>

    <!-- 既存モーダル -->
    <div id="taskModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; z-index:1000;">
        <div style="background:white; padding:20px; border-radius:8px; width:300px;">
            <h3 id="modalTitle">タスク追加</h3>
            <label>タスク名:<br><input type="text" id="modalTaskName" style="width:100%;"></label><br><br>
            <label>作業時間（分）:<br><input type="number" id="modalTaskTime" style="width:100%;" min="1" value="1"></label><br><br>
            <label>期限:<br><input type="date" id="modalTaskDeadline" style="width:100%;"></label><br><br>
            <label>色を選択:<br><input type="color" id="modalTaskColor" value="#4a90e2"></label><br><br>
            <div style="text-align:right;">
                <button id="modalCancelBtn">キャンセル</button>
                <button id="modalAddBtn">追加</button>
            </div>
        </div>
    </div>

    <script>
        /* ここから元のコード開始 */
        const MATRIX_SIZE = Math.min(window.innerWidth, window.innerHeight, 600);
        const COORD_MIN = 0;
        const COORD_MAX = 100;
        const UNIT_PX = MATRIX_SIZE / COORD_MAX;

        const matrix = document.getElementById('matrix-container');
        const axisCanvas = document.getElementById('axisCanvas');
        const ctx = axisCanvas.getContext('2d');
        const addTaskBtn = document.getElementById('addTaskBtn');
        const editTaskBtn = document.getElementById('editTaskBtn');
        const deleteTaskBtn = document.getElementById('deleteTaskBtn');
        const deselectTaskBtn = document.getElementById('deselectTaskBtn');
        const recommendBtn = document.getElementById('recommendBtn');
        const completeTaskBtn = document.getElementById('completeTaskBtn'); // 追加
        const toggleCompletedBtn = document.getElementById('toggleCompletedBtn'); // 追加
        const taskList = document.getElementById('taskList');
        const completedTaskList = document.getElementById('completedTaskList'); // 追加

        const modal = document.getElementById('taskModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalTaskName = document.getElementById('modalTaskName');
        const modalTaskTime = document.getElementById('modalTaskTime');
        const modalTaskDeadline = document.getElementById('modalTaskDeadline');
        const modalTaskColor = document.getElementById('modalTaskColor');
        const modalAddBtn = document.getElementById('modalAddBtn');
        const modalCancelBtn = document.getElementById('modalCancelBtn');

        axisCanvas.width = MATRIX_SIZE;
        axisCanvas.height = MATRIX_SIZE;

        let selectedTasks = new Set();
        let editTarget = null;

        const STORAGE_KEY = 'eisenhower_tasks';
        const ORDER_KEY = 'eisenhower_tasks_order';
        const SHIFT_KEY = 'eisenhower_last_shift_date';
        const COMPLETED_KEY = 'eisenhower_completed_tasks'; // 追加

        /* ▼ 時間フォーマット関数追加 */
        function formatTime(minutes) {
            const h = Math.floor(minutes / 60);
            const m = minutes % 60;
            return `${h}時間${m}分`;
        }

        /* ▼ ラベル表示変更 */
        function labelText(task) {
            let t = `${task.dataset.name}（${formatTime(task.dataset.time)}）`;
            if (task.dataset.deadline) t += `\n期限:${task.dataset.deadline}`;
            return t;
        }

        /* ▼ 時間合計系の表示修正 */
        function updateSelectedTime() {
            let total = 0;
            selectedTasks.forEach(task => { total += parseInt(task.dataset.time); });
            document.getElementById('selectedTime').textContent = `選択タスクの合計時間: ${formatTime(total)}`;
        }

        function updateTotalTime() {
            let total = 0;
            document.querySelectorAll('.task').forEach(task => { total += parseInt(task.dataset.time); });
            document.getElementById('totalTime').textContent = `全タスクの合計時間: ${formatTime(total)}`;
        }

        /* ▼ 完了タスク保存関連 */
        function saveCompletedTask(task) {
            const list = JSON.parse(localStorage.getItem(COMPLETED_KEY) || '[]');
            list.push({
                id: task.dataset.id,
                name: task.dataset.name,
                time: parseInt(task.dataset.time),
                color: task.style.backgroundColor,
                deadline: task.dataset.deadline,
                completedAt: new Date().toLocaleString()
            });
            localStorage.setItem(COMPLETED_KEY, JSON.stringify(list));
        }

        function renderCompletedTasks() {
            completedTaskList.innerHTML = '';
            const list = JSON.parse(localStorage.getItem(COMPLETED_KEY) || '[]');
            if (list.length === 0) {
                completedTaskList.innerHTML = '<p>完了タスクはありません。</p>';
                return;
            }
            list.forEach(t => {
                const div = document.createElement('div');
                div.className = 'completed-item';
                div.textContent = `${t.name}（${formatTime(t.time)}） 期限:${t.deadline || 'なし'} 完了日時:${t.completedAt}`;
                div.style.backgroundColor = t.color;
                completedTaskList.appendChild(div);
            });
        }

        /* ▼ タスク完了ボタン機能 */
        completeTaskBtn.addEventListener('click', () => {
            if (selectedTasks.size === 0) return;
            selectedTasks.forEach(task => {
                saveCompletedTask(task);
                matrix.removeChild(task);
            });
            clearSelection();
            updateTaskListOrder();
            updateTotalTime();
            saveTasksToLocalStorage();
        });

        /* ▼ 完了一覧の表示切替 */
        let showingCompleted = false;
        toggleCompletedBtn.addEventListener('click', () => {
            showingCompleted = !showingCompleted;
            if (showingCompleted) {
                taskList.style.display = 'none';
                completedTaskList.style.display = 'block';
                toggleCompletedBtn.textContent = 'タスク一覧に戻る';
                renderCompletedTasks();
            } else {
                taskList.style.display = 'flex';
                completedTaskList.style.display = 'none';
                toggleCompletedBtn.textContent = '完了タスク一覧';
            }
        });

        /* ▼ 選択時のUI制御に完了ボタンも追加 */
        function selectTask(task) {
            const id = task.dataset.id;
            if (!selectedTasks.has(task)) {
                task.classList.add('selected');
                selectedTasks.add(task);
            } else {
                task.classList.remove('selected');
                selectedTasks.delete(task);
            }
            document.querySelectorAll('.task-list-item').forEach(item => {
                if (item.dataset.id === id) {
                    if (selectedTasks.has(task)) item.classList.add('selected');
                    else item.classList.remove('selected');
                }
            });
            deleteTaskBtn.disabled = selectedTasks.size === 0;
            deselectTaskBtn.disabled = selectedTasks.size === 0;
            editTaskBtn.disabled = selectedTasks.size !== 1;
            completeTaskBtn.disabled = selectedTasks.size === 0; // ←追加
            updateSelectedTime();
        }

        /* ▼ clearSelection修正 */
        function clearSelection() {
            selectedTasks.forEach(task => task.classList.remove('selected'));
            selectedTasks.clear();
            document.querySelectorAll('.task-list-item').forEach(item => item.classList.remove('selected'));
            deleteTaskBtn.disabled = true;
            deselectTaskBtn.disabled = true;
            editTaskBtn.disabled = true;
            completeTaskBtn.disabled = true; // ←追加
            updateSelectedTime();
        }

        /* ▼ 以降は既存処理そのまま（省略） */

        /* --- 最後に初期化 --- */
        document.addEventListener('DOMContentLoaded', () => {
            drawAxes();
            modal.style.display = 'none';
            loadTasksFromLocalStorage();
            applyDailyShiftIfNeeded();
            renderCompletedTasks(); // ←追加
        });
    </script>
</body>
</html>
